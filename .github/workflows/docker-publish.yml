# SPDX-FileCopyrightText: 2025 The Recoil Autohost Authors
#
# SPDX-License-Identifier: CC0-1.0

name: Docker publish

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: Build and push Docker images

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine tags
        id: tags
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          CURRENT_BRANCH="${{ github.ref_name }}"

          if [ "$CURRENT_BRANCH" = "$DEFAULT_BRANCH" ]; then
            NUMBER="${{ github.run_number }}"
          else
            NUMBER="$(git rev-parse --short=10 HEAD)"
          fi

          REPOSITORY="${{ github.repository }}"
          REGISTRY="ghcr.io/${REPOSITORY,,}"

          if [ "$CURRENT_BRANCH" = "$DEFAULT_BRANCH" ]; then
            echo "release_tags=${REGISTRY}:build-${NUMBER},${REGISTRY}:latest" >> "$GITHUB_OUTPUT"
          else
            echo "release_tags=${REGISTRY}:git-${NUMBER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Dockerfile (release)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.release_tags }}
          cache-from: type=gha,scope=release
          cache-to: type=gha,mode=max,scope=release
